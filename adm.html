<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Slam - Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" type="image/png" href="/icon.png">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="menu.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fef9; }
        .form-input {
            width: 100%; padding: 10px; border: 1px solid #d1d5db;
            border-radius: 0.375rem; background-color: #f9fafb; transition: border-color 0.2s;
        }
        .form-input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 1px #10b981; }
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="admin-panel" class="hidden flex h-screen bg-gray-50 overflow-hidden">
        
        <div id="menu-container"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-white border-b md:hidden">
                <h1 class="text-xl font-bold text-emerald-800">Administração</h1>
                <button id="hamburger-button" class="text-gray-500 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
                <div class="container mx-auto space-y-8">
                    <!-- Seção de Gerenciamento de Usuários -->
                    <div>
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold text-gray-800">Gerenciamento de Usuários</h2>
                            <button id="open-match-modal-btn" class="bg-emerald-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-emerald-700 transition-colors w-full sm:w-auto">
                                Criar Nova Partida
                            </button>
                        </div>
                        <div id="user-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                        <div id="no-users-message" class="text-center py-12 text-gray-500 hidden"><p>Nenhum usuário encontrado.</p></div>
                    </div>

                    <!-- Seção de Busca de Partidas -->
                    <div class="pt-8 border-t">
                         <h2 class="text-3xl font-bold text-gray-800 mb-6">Buscar e Gerenciar Partidas</h2>
                         <div class="flex items-center gap-4 mb-6 max-w-lg">
                             <input type="text" id="search-player-name" class="form-input" placeholder="Digite o nome ou apelido do jogador...">
                             <button id="search-matches-btn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-colors">Buscar</button>
                         </div>
                         <div id="matches-search-results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                         <div id="no-matches-found-message" class="text-center py-12 text-gray-500 hidden"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Criar Partida -->
    <div id="match-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Agendar Nova Partida</h3>
            <form id="match-form" class="space-y-4">
                <div><label for="match-local" class="block text-sm font-medium text-gray-700 mb-1">Local</label><input type="text" id="match-local" class="form-input" required></div>
                <div><label for="match-horario" class="block text-sm font-medium text-gray-700 mb-1">Data e Horário</label><input type="datetime-local" id="match-horario" class="form-input" required></div>
                <div><label for="match-p1" class="block text-sm font-medium text-gray-700 mb-1">Participante 1</label><select id="match-p1" class="form-input" required><option value="">Selecione um jogador</option></select></div>
                <div><label for="match-p2" class="block text-sm font-medium text-gray-700 mb-1">Participante 2</label><select id="match-p2" class="form-input" required disabled><option value="">Aguardando Participante 1</option></select></div>
                <div id="match-error" class="text-red-500 text-sm h-5"></div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="close-match-modal-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    <button type="submit" id="save-match-btn" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 font-semibold">Salvar Partida</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Editar Partida -->
    <div id="edit-match-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Editar Partida</h3>
            <form id="edit-match-form" class="space-y-4">
                <input type="hidden" id="edit-match-id">
                <div>
                    <label for="edit-match-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="edit-match-status" class="form-input">
                        <option value="agendada">Agendada</option>
                        <option value="finalizada">Finalizada</option>
                    </select>
                </div>
                <div id="edit-score-container" class="hidden grid-cols-2 gap-4">
                    <div>
                        <label id="edit-p1-name-label" for="edit-p1-score" class="block text-sm font-medium text-gray-700 mb-1">Placar P1</label>
                        <input type="number" id="edit-p1-score" class="form-input text-center font-bold" min="0">
                    </div>
                     <div>
                        <label id="edit-p2-name-label" for="edit-p2-score" class="block text-sm font-medium text-gray-700 mb-1">Placar P2</label>
                        <input type="number" id="edit-p2-score" class="form-input text-center font-bold" min="0">
                    </div>
                </div>
                <div><label for="edit-match-local" class="block text-sm font-medium text-gray-700 mb-1">Local</label><input type="text" id="edit-match-local" class="form-input" required></div>
                <div><label for="edit-match-horario" class="block text-sm font-medium text-gray-700 mb-1">Data e Horário</label><input type="datetime-local" id="edit-match-horario" class="form-input" required></div>
                <div id="edit-match-error" class="text-red-500 text-sm h-5"></div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="close-edit-match-modal-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    <button type="submit" id="save-edit-match-btn" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading-view" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[100]">
        <svg class="animate-spin h-12 w-12 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loading-message" class="mt-4 text-lg font-medium text-emerald-800">Carregando...</p>
    </div>

    <script type="module">
        import { auth, db } from './firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { ref, get, update, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { loadMenu } from './menu.js';

        // --- Variáveis Globais ---
        let allUsers = {};
        let allMatches = {};
        const categories = ["Grand Slam", "Master 1000", "Challenger"];
        let currentSearchedUserId = null;

        // --- Funções de Gerenciamento de Usuários ---
        const createUserCard = (uid, data) => {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-md space-y-3 transition-shadow hover:shadow-lg';
            card.dataset.uid = uid;
            card.innerHTML = `
                <div><label class="text-xs font-medium text-gray-500">Nome</label><div data-field="name" class="text-lg font-semibold text-gray-800 break-words">${data.name || ''}</div></div>
                <div><label class="text-xs font-medium text-gray-500">Apelido</label><div data-field="nickname" class="text-gray-800 break-words">${data.nickname || 'N/A'}</div></div>
                <div><label class="text-xs font-medium text-gray-500">Categoria</label><div data-field="category" class="text-gray-800 font-medium">${data.category || 'Não definida'}</div></div>
                <div class="pt-3 border-t flex justify-end space-x-2">
                    <button class="edit-btn bg-blue-500 text-white px-4 py-1.5 rounded-lg hover:bg-blue-600 text-sm font-semibold">Editar</button>
                    <button class="save-btn bg-emerald-500 text-white px-4 py-1.5 rounded-lg hover:bg-emerald-600 text-sm font-semibold hidden">Salvar</button>
                    <button class="cancel-btn bg-gray-500 text-white px-4 py-1.5 rounded-lg hover:bg-gray-600 text-sm font-semibold hidden">Cancelar</button>
                </div>`;
            card.querySelector('.edit-btn').addEventListener('click', () => toggleEditMode(card, true, data));
            card.querySelector('.cancel-btn').addEventListener('click', () => toggleEditMode(card, false, data));
            card.querySelector('.save-btn').addEventListener('click', () => saveUserData(card));
            return card;
        };

        const toggleEditMode = (card, isEditing, originalData) => {
            const fields = { name: 'input', nickname: 'input', category: 'select' };
            card.querySelector('.edit-btn').classList.toggle('hidden', isEditing);
            card.querySelector('.save-btn').classList.toggle('hidden', !isEditing);
            card.querySelector('.cancel-btn').classList.toggle('hidden', !isEditing);

            for (const [key, type] of Object.entries(fields)) {
                const fieldDiv = card.querySelector(`[data-field="${key}"]`);
                if (isEditing) {
                    if (type === 'input') {
                        fieldDiv.innerHTML = `<input type="text" value="${originalData[key] || ''}" class="form-input text-base">`;
                    } else {
                        const options = `<option value="">Selecione</option>` + categories.map(cat => `<option value="${cat}" ${originalData.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
                        fieldDiv.innerHTML = `<select class="form-input text-base">${options}</select>`;
                    }
                } else {
                    fieldDiv.innerHTML = originalData[key] || (key === 'nickname' ? 'N/A' : 'Não definida');
                }
            }
        };

        const saveUserData = async (card) => {
            const uid = card.dataset.uid;
            const saveBtn = card.querySelector('.save-btn');
            const updates = {
                name: card.querySelector('[data-field="name"] input').value,
                nickname: card.querySelector('[data-field="nickname"] input').value,
                category: card.querySelector('[data-field="category"] select').value
            };
            saveBtn.textContent = 'Salvando...';
            saveBtn.disabled = true;
            try {
                await update(ref(db, `users/${uid}`), updates);
                toggleEditMode(card, false, updates);
                allUsers[uid] = {...allUsers[uid], ...updates};
            } catch (error) {
                console.error("Erro ao salvar:", error);
                alert("Falha ao salvar.");
                toggleEditMode(card, false, allUsers[uid]);
            } finally {
                saveBtn.textContent = 'Salvar';
                saveBtn.disabled = false;
            }
        };

        const populatePlayerDropdowns = () => {
            const p1Select = document.getElementById('match-p1');
            p1Select.innerHTML = '<option value="">Selecione um jogador</option>';
            Object.entries(allUsers).forEach(([uid, user]) => {
                if (user.email !== 'grandslam@gmail.com') {
                    const option = document.createElement('option');
                    option.value = uid;
                    option.textContent = user.nickname || user.name;
                    p1Select.appendChild(option);
                }
            });
        };

        // --- Inicialização ---
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'grandslam@gmail.com') {
                loadMenu('menu-container', 'adm');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('loading-view').classList.add('hidden');
                loadInitialData();
            } else {
                window.location.href = user ? 'home.html' : 'index.html';
            }
        });

        const loadInitialData = async () => {
            const usersRef = ref(db, 'users/');
            const matchesRef = ref(db, 'matches/');
            const [usersSnapshot, matchesSnapshot] = await Promise.all([get(usersRef), get(matchesRef)]);
            
            if (usersSnapshot.exists()) allUsers = usersSnapshot.val();
            if (matchesSnapshot.exists()) allMatches = matchesSnapshot.val();
            
            renderUserManagement();
        };

        const renderUserManagement = () => {
            const userCardsContainer = document.getElementById('user-cards-container');
            const noUsersMessage = document.getElementById('no-users-message');
            userCardsContainer.innerHTML = '';
            const usersToDisplay = Object.entries(allUsers).filter(([_, u]) => u.email !== 'grandslam@gmail.com');

            if(usersToDisplay.length === 0) {
                noUsersMessage.classList.remove('hidden');
                return;
            }
            noUsersMessage.classList.add('hidden');

            usersToDisplay.forEach(([uid, userData]) => {
                const card = createUserCard(uid, userData);
                userCardsContainer.appendChild(card);
            });
            populatePlayerDropdowns();
        };

        // --- Lógica de Criar Partida ---
        const matchModal = document.getElementById('match-modal');
        const p1Select = document.getElementById('match-p1');
        const p2Select = document.getElementById('match-p2');
        
        p1Select.addEventListener('change', () => {
            const p1_uid = p1Select.value;
            p2Select.innerHTML = '<option value="">Aguardando Participante 1</option>';
            if (!p1_uid) { p2Select.disabled = true; return; }
            const p1_category = allUsers[p1_uid]?.category;
            if (!p1_category) { p2Select.disabled = true; return; }
            
            p2Select.innerHTML = '<option value="">Selecione um jogador</option>';
            p2Select.disabled = false;
            Object.entries(allUsers).forEach(([uid, user]) => {
                if (uid !== p1_uid && user.category === p1_category) {
                    const option = document.createElement('option');
                    option.value = uid;
                    option.textContent = user.nickname || user.name;
                    p2Select.appendChild(option);
                }
            });
        });

        document.getElementById('match-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newMatch = {
                local: document.getElementById('match-local').value,
                horario: document.getElementById('match-horario').value,
                participante1_uid: p1Select.value,
                participante2_uid: p2Select.value,
                status: 'agendada',
                createdAt: new Date().toISOString()
            };
            if (!newMatch.local || !newMatch.horario || !newMatch.participante1_uid || !newMatch.participante2_uid) {
                document.getElementById('match-error').textContent = "Todos os campos são obrigatórios.";
                return;
            }
            try {
                await push(ref(db, 'matches/'), newMatch);
                alert('Partida criada com sucesso!');
                e.target.reset();
                matchModal.classList.add('hidden');
                loadInitialData(); // Recarrega os dados para refletir a nova partida
            } catch (error) {
                document.getElementById('match-error').textContent = "Erro ao salvar a partida.";
            }
        });

        document.getElementById('open-match-modal-btn').addEventListener('click', () => matchModal.classList.remove('hidden'));
        document.getElementById('close-match-modal-btn').addEventListener('click', () => matchModal.classList.add('hidden'));

        // --- Lógica de Busca de Partidas ---
        const searchButton = document.getElementById('search-matches-btn');
        const searchInput = document.getElementById('search-player-name');

        const searchPlayerMatches = () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('matches-search-results-container');
            const noResultsMessage = document.getElementById('no-matches-found-message');
            
            resultsContainer.innerHTML = '';
            noResultsMessage.classList.add('hidden');
            currentSearchedUserId = null;

            if (!searchTerm) return;

            for (const [uid, user] of Object.entries(allUsers)) {
                if ((user.name || '').toLowerCase().includes(searchTerm) || (user.nickname || '').toLowerCase().includes(searchTerm)) {
                    currentSearchedUserId = uid;
                    break; 
                }
            }

            if (!currentSearchedUserId) {
                noResultsMessage.textContent = `Nenhum jogador encontrado com o termo "${searchInput.value}".`;
                noResultsMessage.classList.remove('hidden');
                return;
            }
            
            renderSearchedMatches();
        };

        const renderSearchedMatches = () => {
            const resultsContainer = document.getElementById('matches-search-results-container');
            const noResultsMessage = document.getElementById('no-matches-found-message');
            resultsContainer.innerHTML = '';

            if (!currentSearchedUserId) return;

            const playerMatches = Object.entries(allMatches).filter(([_, match]) => 
                match.participante1_uid === currentSearchedUserId || match.participante2_uid === currentSearchedUserId
            ).sort((a, b) => new Date(b[1].horario) - new Date(a[1].horario));

            if (playerMatches.length === 0) {
                const playerName = allUsers[currentSearchedUserId]?.name || 'o jogador';
                noResultsMessage.textContent = `Nenhum jogo encontrado para ${playerName}.`;
                noResultsMessage.classList.remove('hidden');
                return;
            }
            
            noResultsMessage.classList.add('hidden');
            playerMatches.forEach(([matchId, matchData]) => {
                const matchCard = createMatchResultCard(matchId, matchData);
                resultsContainer.appendChild(matchCard);
            });
        };

        searchButton.addEventListener('click', searchPlayerMatches);
        searchInput.addEventListener('keydown', (e) => e.key === 'Enter' && searchPlayerMatches());

        function createMatchResultCard(matchId, match) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-md space-y-3 flex flex-col';
            const p1 = allUsers[match.participante1_uid];
            const p2 = allUsers[match.participante2_uid];
            const p1Name = p1?.nickname || p1?.name || '?';
            const p2Name = p2?.nickname || p2?.name || '?';
            const date = new Date(match.horario).toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });

            let statusHTML;
            if (match.status === 'finalizada') {
                statusHTML = `<div class="text-center font-bold text-sm py-1 px-3 rounded-full mt-2 bg-gray-200 text-gray-800">Finalizada: ${match.score}</div>`;
            } else {
                statusHTML = `<div class="text-center font-bold text-sm py-1 px-3 rounded-full mt-2 bg-blue-100 text-blue-800">Agendada</div>`;
            }

            card.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-gray-800">${p1Name} vs ${p2Name}</p>
                    <div class="text-sm text-gray-600 mt-2 space-y-1">
                        <p><strong>Data:</strong> ${date}</p>
                    </div>
                    ${statusHTML}
                </div>
                <div class="pt-3 border-t flex justify-end space-x-2">
                    <button class="edit-match-btn bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 text-sm font-semibold">Editar</button>
                    <button class="delete-match-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 text-sm font-semibold">Excluir</button>
                </div>
            `;

            card.querySelector('.edit-match-btn').addEventListener('click', () => openEditMatchModal(matchId, match));
            card.querySelector('.delete-match-btn').addEventListener('click', () => deleteMatch(matchId, match));
            return card;
        }

        // --- Lógica de Edição de Partida ---
        const editModal = document.getElementById('edit-match-modal');
        const editForm = document.getElementById('edit-match-form');
        const editScoreContainer = document.getElementById('edit-score-container');

        function openEditMatchModal(matchId, match) {
            editForm.reset();
            document.getElementById('edit-match-error').textContent = '';
            document.getElementById('edit-match-id').value = matchId;
            document.getElementById('edit-match-local').value = match.local;
            document.getElementById('edit-match-horario').value = match.horario;
            document.getElementById('edit-match-status').value = match.status;

            const p1Name = allUsers[match.participante1_uid]?.name || '?';
            const p2Name = allUsers[match.participante2_uid]?.name || '?';
            document.getElementById('edit-p1-name-label').textContent = `Placar ${p1Name}`;
            document.getElementById('edit-p2-name-label').textContent = `Placar ${p2Name}`;

            if (match.status === 'finalizada') {
                editScoreContainer.style.display = 'grid';
                const scores = match.score ? match.score.split('x').map(s => s.trim()) : ['',''];
                document.getElementById('edit-p1-score').value = scores[0];
                document.getElementById('edit-p2-score').value = scores[1];
            } else {
                editScoreContainer.style.display = 'none';
            }
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }

        document.getElementById('edit-match-status').addEventListener('change', (e) => {
            editScoreContainer.style.display = e.target.value === 'finalizada' ? 'grid' : 'none';
        });
        
        document.getElementById('close-edit-match-modal-btn').addEventListener('click', () => {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = document.getElementById('save-edit-match-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';

            const matchId = document.getElementById('edit-match-id').value;
            const originalMatch = allMatches[matchId];
            const updates = {};
            
            if (originalMatch.status === 'finalizada') {
                Object.assign(updates, await calculatePointReversion(originalMatch));
            }

            const newStatus = document.getElementById('edit-match-status').value;
            updates[`/matches/${matchId}/local`] = document.getElementById('edit-match-local').value;
            updates[`/matches/${matchId}/horario`] = document.getElementById('edit-match-horario').value;
            updates[`/matches/${matchId}/status`] = newStatus;
            
            if (newStatus === 'finalizada') {
                const p1_score = parseInt(document.getElementById('edit-p1-score').value, 10);
                const p2_score = parseInt(document.getElementById('edit-p2-score').value, 10);
                
                if (isNaN(p1_score) || isNaN(p2_score) || p1_score === p2_score) {
                    document.getElementById('edit-match-error').textContent = 'Placar inválido.';
                    saveBtn.disabled = false; saveBtn.textContent = 'Salvar Alterações';
                    return;
                }
                
                updates[`/matches/${matchId}/score`] = `${p1_score} x ${p2_score}`;
                const winner_uid = p1_score > p2_score ? originalMatch.participante1_uid : originalMatch.participante2_uid;
                updates[`/matches/${matchId}/winner_uid`] = winner_uid;
                
                Object.assign(updates, await calculatePointAddition(originalMatch, winner_uid, p1_score, p2_score));
            } else {
                updates[`/matches/${matchId}/score`] = null;
                updates[`/matches/${matchId}/winner_uid`] = null;
            }

            try {
                await update(ref(db), updates);
                await loadInitialData();
                renderSearchedMatches();
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
            } catch (error) {
                console.error("Erro ao salvar partida:", error);
                document.getElementById('edit-match-error').textContent = 'Erro ao salvar.';
            } finally {
                saveBtn.disabled = false; saveBtn.textContent = 'Salvar Alterações';
            }
        });

        // --- Lógica de Exclusão de Partida ---
        const deleteMatch = async (matchId, matchData) => {
            if (!confirm('Tem certeza que deseja excluir esta partida? Esta ação não pode ser desfeita.')) return;

            const updates = {};
            if (matchData.status === 'finalizada') {
                Object.assign(updates, await calculatePointReversion(matchData));
            }
            updates[`/matches/${matchId}`] = null;

            try {
                await update(ref(db), updates);
                await loadInitialData();
                renderSearchedMatches();
                alert('Partida excluída com sucesso.');
            } catch (error) {
                console.error("Erro ao excluir partida:", error);
                alert('Falha ao excluir a partida.');
            }
        };

        // --- Funções de Cálculo de Pontos ---
        const getPointLogic = (p1_score, p2_score) => {
            const winner_score = Math.max(p1_score, p2_score);
            const loser_score = Math.min(p1_score, p2_score);
            const scoreDifference = winner_score - loser_score;
            const winnerPoints = scoreDifference >= 4 ? 8 : 7;
            const loserPoints = loser_score;
            return { winnerPoints, loserPoints };
        };

        async function calculatePointReversion(match) {
            const updates = {};
            const { participante1_uid: p1_uid, participante2_uid: p2_uid, winner_uid, score } = match;
            if (!winner_uid || !score) return {};

            const loser_uid = winner_uid === p1_uid ? p2_uid : p1_uid;
            const scores = score.split('x').map(s => parseInt(s.trim(), 10));
            
            const p1_score_in_match = winner_uid === p1_uid ? Math.max(...scores) : Math.min(...scores);
            const p2_score_in_match = winner_uid === p2_uid ? Math.max(...scores) : Math.min(...scores);

            const { winnerPoints, loserPoints } = getPointLogic(p1_score_in_match, p2_score_in_match);

            const winnerCurrentPoints = (await get(ref(db, `users/${winner_uid}/points`))).val() || 0;
            const loserCurrentPoints = (await get(ref(db, `users/${loser_uid}/points`))).val() || 0;
            
            updates[`/users/${winner_uid}/points`] = winnerCurrentPoints - winnerPoints;
            updates[`/users/${loser_uid}/points`] = loserCurrentPoints - loserPoints;
            return updates;
        }

        async function calculatePointAddition(match, winner_uid, p1_score, p2_score) {
            const updates = {};
            const loser_uid = winner_uid === match.participante1_uid ? match.participante2_uid : match.participante1_uid;
            const { winnerPoints, loserPoints } = getPointLogic(p1_score, p2_score);

            const winnerCurrentPoints = (await get(ref(db, `users/${winner_uid}/points`))).val() || 0;
            const loserCurrentPoints = (await get(ref(db, `users/${loser_uid}/points`))).val() || 0;

            updates[`/users/${winner_uid}/points`] = winnerCurrentPoints + winnerPoints;
            updates[`/users/${loser_uid}/points`] = loserCurrentPoints + loserPoints;
            return updates;
        }
    </script>
</body>
</html>
