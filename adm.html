<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Slam - Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" type="image/png" href="/icon.png">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="menu.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fef9; }
        .form-input {
            width: 100%; padding: 10px; border: 1px solid #d1d5db;
            border-radius: 0.375rem; background-color: #f9fafb; transition: border-color 0.2s;
        }
        .form-input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 1px #10b981; }
        .modal { transition: opacity 0.3s ease; }
        .admin-tab {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .admin-tab.active {
            color: #059669; /* emerald-700 */
            border-bottom-color: #059669;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div id="admin-panel" class="hidden flex h-screen bg-gray-50 overflow-hidden">
        
        <div id="menu-container"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-white border-b md:hidden">
                <h1 class="text-xl font-bold text-emerald-800">Administração</h1>
                <button id="hamburger-button" class="text-gray-500 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
                <div class="container mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Painel do Administrador</h2>
                    <p class="text-gray-500 mb-6">Gerencie usuários, partidas e configurações do sistema.</p>

                    <!-- Abas de Navegação -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex -mb-px" id="admin-tabs">
                            <button data-tab="users" class="admin-tab active">Gerenciar Usuários</button>
                            <button data-tab="matches" class="admin-tab">Gerenciar Partidas</button>
                            <button data-tab="tools" class="admin-tab">Ferramentas</button>
                        </nav>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div id="tab-content-container">
                        <!-- Aba de Usuários -->
                        <div id="tab-users" class="tab-content active">
                            <div id="user-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                            <div id="no-users-message" class="text-center py-12 text-gray-500 hidden"><p>Nenhum usuário encontrado.</p></div>
                            <div id="pagination-controls" class="flex justify-center items-center mt-8 space-x-4"></div>
                        </div>

                        <!-- Aba de Partidas -->
                        <div id="tab-matches" class="tab-content">
                            <div class="flex items-center gap-4 mb-6 max-w-lg">
                                <input type="text" id="search-player-name" class="form-input" placeholder="Digite o nome ou apelido do jogador...">
                                <button id="search-matches-btn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-colors">Buscar</button>
                            </div>
                            <div id="matches-search-results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                            <div id="no-matches-found-message" class="text-center py-12 text-gray-500 hidden"></div>
                        </div>

                        <!-- Aba de Ferramentas -->
                        <div id="tab-tools" class="tab-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-white p-6 rounded-lg shadow-sm border">
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">Ações Rápidas</h3>
                                    <p class="text-gray-500 mb-4">Crie dados de teste ou novas partidas.</p>
                                    <div class="flex flex-col gap-3">
                                        <button id="open-match-modal-btn" class="w-full text-left bg-emerald-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-emerald-700 transition-colors">Criar Nova Partida</button>
                                        <button id="create-test-accounts-btn" class="w-full text-left bg-amber-500 text-white font-semibold px-5 py-3 rounded-lg hover:bg-amber-600 transition-colors">Criar 60 Contas de Teste</button>
                                    </div>
                                </div>
                                <div class="bg-white p-6 rounded-lg shadow-sm border">
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">Reset de Temporada</h3>
                                    <p class="text-gray-500 mb-4">Execute ações em massa para gerenciar o ciclo de vida do ranking.</p>
                                    <div class="space-y-4">
                                        <button id="month-closing-btn" class="w-full bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-blue-700 transition-colors">Fechamento de Mês</button>
                                        <div class="flex items-center gap-3">
                                            <select id="reset-category-select" class="form-input"><option value="">Selecione a categoria</option></select>
                                            <button id="reset-points-btn" class="bg-red-600 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-red-700 transition-colors whitespace-nowrap">Resetar Pontos</button>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <select id="delete-matches-category-select" class="form-input"><option value="">Selecione a categoria</option></select>
                                            <button id="delete-matches-btn" class="bg-red-800 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-red-900 transition-colors whitespace-nowrap">Excluir Partidas</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modais (sem alteração na estrutura) -->
    <div id="match-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Agendar Nova Partida</h3>
            <form id="match-form" class="space-y-4">
                <div><label for="match-local" class="block text-sm font-medium text-gray-700 mb-1">Local</label><input type="text" id="match-local" class="form-input" required></div>
                <div><label for="match-horario" class="block text-sm font-medium text-gray-700 mb-1">Data e Horário</label><input type="datetime-local" id="match-horario" class="form-input" required></div>
                <div><label for="match-p1" class="block text-sm font-medium text-gray-700 mb-1">Participante 1</label><select id="match-p1" class="form-input" required><option value="">Selecione</option></select></div>
                <div><label for="match-p2" class="block text-sm font-medium text-gray-700 mb-1">Participante 2</label><select id="match-p2" class="form-input" required disabled><option value="">Aguardando P1</option></select></div>
                <div id="match-error" class="text-red-500 text-sm h-5"></div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="close-match-modal-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    <button type="submit" id="save-match-btn" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 font-semibold">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-match-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <!-- ... (código do modal de edição de partida inalterado) ... -->
    </div>

    <div id="loading-view" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-[100]" style="display: none;">
        <svg class="animate-spin h-12 w-12 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loading-message" class="mt-4 text-lg font-medium text-emerald-800">Carregando...</p>
    </div>

    <script type="module">
        import { auth, db } from './firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { ref, get, update, push, set, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { loadMenu } from './menu.js';

        // --- Variáveis Globais ---
        let allUsers = {};
        let allMatches = {};
        const categories = ["Grand Slam", "Master 1000", "Challenger"];
        let currentSearchedUserId = null;
        
        // --- Variáveis de Paginação ---
        let currentPage = 1;
        const usersPerPage = 12;

        const loadingView = document.getElementById('loading-view');
        const loadingMessage = document.getElementById('loading-message');

        // --- Inicialização e Autenticação ---
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'grandslam@gmail.com') {
                loadMenu('menu-container', 'adm');
                document.getElementById('admin-panel').classList.remove('hidden');
                setupTabs();
                loadInitialData();
            } else {
                window.location.href = user ? 'home.html' : 'index.html';
            }
        });

        const loadInitialData = async () => {
            loadingView.style.display = 'flex';
            loadingMessage.textContent = 'Carregando dados...';
            const usersRef = ref(db, 'users/');
            const matchesRef = ref(db, 'matches/');
            try {
                const [usersSnapshot, matchesSnapshot] = await Promise.all([get(usersRef), get(matchesRef)]);
                allUsers = usersSnapshot.exists() ? usersSnapshot.val() : {};
                allMatches = matchesSnapshot.exists() ? matchesSnapshot.val() : {};
                renderUserManagement(1); // Renderiza a primeira página
                populatePlayerDropdowns();
                populateCategoryDropdowns();
            } catch (error) {
                console.error("Erro ao carregar dados iniciais:", error);
                alert("Falha ao carregar os dados do sistema.");
            } finally {
                loadingView.style.display = 'none';
            }
        };

        // --- Lógica das Abas (Submenu) ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.admin-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tab.classList.add('active');

                    const targetTab = tab.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.id === `tab-${targetTab}` ? content.classList.add('active') : content.classList.remove('active');
                    });
                });
            });
        }
        
        // --- Lógica de Gerenciamento de Usuários com Paginação ---
        const renderUserManagement = (page) => {
            currentPage = page;
            const userCardsContainer = document.getElementById('user-cards-container');
            const noUsersMessage = document.getElementById('no-users-message');
            userCardsContainer.innerHTML = '';
            
            const usersToDisplay = Object.entries(allUsers)
                .filter(([_, u]) => u.email !== 'grandslam@gmail.com')
                .sort((a, b) => (b[1].points || 0) - (a[1].points || 0)); // Ordena por pontos

            if(usersToDisplay.length === 0) {
                noUsersMessage.classList.remove('hidden');
                document.getElementById('pagination-controls').innerHTML = '';
                return;
            }
            noUsersMessage.classList.add('hidden');
            
            const startIndex = (page - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const paginatedUsers = usersToDisplay.slice(startIndex, endIndex);

            paginatedUsers.forEach(([uid, userData]) => {
                const card = createUserCard(uid, userData);
                userCardsContainer.appendChild(card);
            });
            
            renderPaginationControls(usersToDisplay.length);
        };
        
        const renderPaginationControls = (totalUsers) => {
            const container = document.getElementById('pagination-controls');
            container.innerHTML = '';
            const totalPages = Math.ceil(totalUsers / usersPerPage);
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.className = "bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed";
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => renderUserManagement(currentPage - 1);
            
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            pageInfo.className = "font-semibold text-gray-700";

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Próxima';
            nextButton.className = "bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed";
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => renderUserManagement(currentPage + 1);

            container.append(prevButton, pageInfo, nextButton);
        };
        
        const createUserCard = (uid, data) => {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-md space-y-3 transition-shadow hover:shadow-lg';
            card.dataset.uid = uid;
            card.innerHTML = `
                <div><label class="text-xs font-medium text-gray-500">Nome</label><div data-field="name" class="text-lg font-semibold text-gray-800 break-words">${data.name || ''}</div></div>
                <div><label class="text-xs font-medium text-gray-500">Apelido</label><div data-field="nickname" class="text-gray-800 break-words">${data.nickname || 'N/A'}</div></div>
                <div><label class="text-xs font-medium text-gray-500">Categoria</label><div data-field="category" class="text-gray-800 font-medium">${data.category || 'Não definida'}</div></div>
                <div><label class="text-xs font-medium text-gray-500">Pontos</label><div class="text-lg font-bold text-emerald-600">${data.points || 0}</div></div>
                <div class="pt-3 border-t flex justify-end space-x-2">
                    <button class="edit-btn bg-blue-500 text-white px-4 py-1.5 rounded-lg hover:bg-blue-600 text-sm font-semibold">Editar</button>
                    <button class="save-btn bg-emerald-500 text-white px-4 py-1.5 rounded-lg hover:bg-emerald-600 text-sm font-semibold hidden">Salvar</button>
                    <button class="cancel-btn bg-gray-500 text-white px-4 py-1.5 rounded-lg hover:bg-gray-600 text-sm font-semibold hidden">Cancelar</button>
                </div>`;
            card.querySelector('.edit-btn').addEventListener('click', () => toggleEditMode(card, true, data));
            card.querySelector('.cancel-btn').addEventListener('click', () => toggleEditMode(card, false, data));
            card.querySelector('.save-btn').addEventListener('click', () => saveUserData(card));
            return card;
        };
        const toggleEditMode = (card, isEditing, originalData) => {
            const fields = { name: 'input', nickname: 'input', category: 'select' };
            card.querySelector('.edit-btn').classList.toggle('hidden', isEditing);
            card.querySelector('.save-btn').classList.toggle('hidden', !isEditing);
            card.querySelector('.cancel-btn').classList.toggle('hidden', !isEditing);

            for (const [key, type] of Object.entries(fields)) {
                const fieldDiv = card.querySelector(`[data-field="${key}"]`);
                if (isEditing) {
                    if (type === 'input') {
                        fieldDiv.innerHTML = `<input type="text" value="${originalData[key] || ''}" class="form-input text-base">`;
                    } else {
                        const options = `<option value="">Selecione</option>` + categories.map(cat => `<option value="${cat}" ${originalData.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
                        fieldDiv.innerHTML = `<select class="form-input text-base">${options}</select>`;
                    }
                } else {
                    fieldDiv.innerHTML = originalData[key] || (key === 'nickname' ? 'N/A' : 'Não definida');
                }
            }
        };
        const saveUserData = async (card) => {
            const uid = card.dataset.uid;
            const saveBtn = card.querySelector('.save-btn');
            const updates = {
                name: card.querySelector('[data-field="name"] input').value,
                nickname: card.querySelector('[data-field="nickname"] input').value,
                category: card.querySelector('[data-field="category"] select').value
            };
            saveBtn.textContent = 'Salvando...';
            saveBtn.disabled = true;
            try {
                await update(ref(db, `users/${uid}`), updates);
                toggleEditMode(card, false, updates);
                allUsers[uid] = {...allUsers[uid], ...updates};
            } catch (error) {
                console.error("Erro ao salvar:", error);
                alert("Falha ao salvar.");
                toggleEditMode(card, false, allUsers[uid]);
            } finally {
                saveBtn.textContent = 'Salvar';
                saveBtn.disabled = false;
            }
        };

        // --- Lógica das Ferramentas ---
        const populateCategoryDropdowns = () => {
            const resetSelect = document.getElementById('reset-category-select');
            const deleteSelect = document.getElementById('delete-matches-category-select');
            resetSelect.innerHTML = '<option value="">Selecione a categoria</option>';
            deleteSelect.innerHTML = '<option value="">Selecione a categoria</option>';
            categories.forEach(cat => {
                resetSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                deleteSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        };

        document.getElementById('create-test-accounts-btn').addEventListener('click', async () => {
            const password = prompt("Por favor, digite a senha de administrador para continuar:");
            if (password !== "Czar@w1ll14m") {
                if (password !== null) { // Não alerta se o usuário clicou em "Cancelar"
                    alert("Senha incorreta. Ação cancelada.");
                }
                return;
            }

            if (!confirm('Senha correta. Tem certeza que deseja criar 60 contas de teste no banco de dados?')) return;
            
            loadingView.style.display = 'flex';
            const totalAccounts = 60;
            try {
                for (let i = 1; i <= totalAccounts; i++) {
                    loadingMessage.textContent = `Criando conta ${i}/${totalAccounts}...`;
                    const category = categories[i % categories.length];
                    const newUserRef = push(ref(db, 'users'));
                    await set(newUserRef, {
                        name: `Jogador Teste ${i}`,
                        nickname: `Tester${i}`,
                        age: Math.floor(Math.random() * 30) + 20,
                        email: `tester${Date.now()}_${i}@grandslam.com`,
                        category: category,
                        points: 0
                    });
                }
                alert(`${totalAccounts} contas de teste criadas com sucesso!`);
            } catch (error) {
                console.error("Erro ao criar contas de teste:", error);
                alert(`Ocorreu um erro: ${error.message}`);
            } finally {
                await loadInitialData();
            }
        });

        document.getElementById('month-closing-btn').addEventListener('click', async () => {
            if (!confirm('Tem certeza que deseja executar o fechamento de mês? As categorias de TODOS os jogadores serão recalculadas com base na pontuação atual.')) return;

            loadingView.style.display = 'flex';
            loadingMessage.textContent = 'Iniciando fechamento de mês...';
            
            try {
                const usersArray = Object.entries(allUsers)
                    .filter(([_, user]) => user.email !== 'grandslam@gmail.com')
                    .sort(([, userA], [, userB]) => (userB.points || 0) - (userA.points || 0));

                const updates = {};
                loadingMessage.textContent = 'Calculando novas categorias...';

                usersArray.forEach(([uid, user], index) => {
                    let newCategory = 'Challenger';
                    if (index < 20) {
                        newCategory = 'Grand Slam';
                    } else if (index < 40) {
                        newCategory = 'Master 1000';
                    }
                    
                    if (user.category !== newCategory) {
                        updates[`/users/${uid}/category`] = newCategory;
                    }
                });

                if (Object.keys(updates).length > 0) {
                    loadingMessage.textContent = 'Atualizando banco de dados...';
                    await update(ref(db), updates);
                    alert('Fechamento de mês concluído! As categorias dos jogadores foram atualizadas.');
                } else {
                    alert('Nenhuma alteração de categoria foi necessária.');
                }

            } catch (error) {
                console.error("Erro no fechamento de mês:", error);
                alert(`Ocorreu um erro: ${error.message}`);
            } finally {
                await loadInitialData();
            }
        });

        document.getElementById('reset-points-btn').addEventListener('click', async () => {
            const categoryToReset = document.getElementById('reset-category-select').value;
            if (!categoryToReset) {
                alert('Por favor, selecione uma categoria para resetar.');
                return;
            }
            if (!confirm(`TEM CERTEZA que deseja resetar a pontuação de TODOS os jogadores da categoria "${categoryToReset}" para 0?`)) return;
            
            loadingView.style.display = 'flex';
            loadingMessage.textContent = `Resetando pontos da categoria ${categoryToReset}...`;
            const updates = {};
            Object.entries(allUsers).forEach(([uid, user]) => {
                if (user.category === categoryToReset) {
                    updates[`/users/${uid}/points`] = 0;
                }
            });

            try {
                await update(ref(db), updates);
                alert(`Pontuação da categoria "${categoryToReset}" resetada com sucesso!`);
            } catch (error) {
                console.error("Erro ao resetar pontos:", error);
                alert(`Ocorreu um erro: ${error.message}`);
            } finally {
                await loadInitialData();
            }
        });

        document.getElementById('delete-matches-btn').addEventListener('click', async () => {
            const categoryToDelete = document.getElementById('delete-matches-category-select').value;
            if (!categoryToDelete) {
                alert('Por favor, selecione uma categoria para excluir as partidas.');
                return;
            }
            if (!confirm(`TEM CERTEZA que deseja excluir TODAS as partidas dos jogadores da categoria "${categoryToDelete}"? Esta ação não pode ser desfeita.`)) return;

            loadingView.style.display = 'flex';
            loadingMessage.textContent = `Excluindo partidas da categoria ${categoryToDelete}...`;
            const updates = {};
            Object.entries(allMatches).forEach(([matchId, matchData]) => {
                const p1_uid = matchData.participante1_uid;
                if (allUsers[p1_uid] && allUsers[p1_uid].category === categoryToDelete) {
                    updates[`/matches/${matchId}`] = null;
                }
            });

             try {
                await update(ref(db), updates);
                alert(`Partidas da categoria "${categoryToDelete}" excluídas com sucesso!`);
            } catch (error) {
                console.error("Erro ao excluir partidas:", error);
                alert(`Ocorreu um erro: ${error.message}`);
            } finally {
                await loadInitialData();
            }
        });

        // --- Lógica de Partidas (código existente, apenas movido ou com pequenas adaptações) ---
        const populatePlayerDropdowns = () => {
            const p1Select = document.getElementById('match-p1');
            p1Select.innerHTML = '<option value="">Selecione um jogador</option>';
            Object.entries(allUsers).forEach(([uid, user]) => {
                if (user.email !== 'grandslam@gmail.com') {
                    const option = document.createElement('option');
                    option.value = uid;
                    option.textContent = user.nickname || user.name;
                    p1Select.appendChild(option);
                }
            });
        };
        const matchModal = document.getElementById('match-modal');
        const p1Select = document.getElementById('match-p1');
        const p2Select = document.getElementById('match-p2');
        document.getElementById('open-match-modal-btn').addEventListener('click', () => matchModal.classList.remove('hidden'));
        document.getElementById('close-match-modal-btn').addEventListener('click', () => matchModal.classList.add('hidden'));
        p1Select.addEventListener('change', () => {
            const p1_uid = p1Select.value;
            p2Select.innerHTML = '<option value="">Aguardando Participante 1</option>';
            if (!p1_uid) { p2Select.disabled = true; return; }
            const p1Data = allUsers[p1_uid];
            if (!p1Data || !p1Data.category) { 
                p2Select.disabled = true; 
                p2Select.innerHTML = '<option value="">P1 sem categoria</option>';
                return; 
            }
            p2Select.innerHTML = '<option value="">Selecione um jogador</option>';
            p2Select.disabled = false;
            Object.entries(allUsers).forEach(([uid, user]) => {
                if (uid !== p1_uid && user.category === p1Data.category) {
                    const option = document.createElement('option');
                    option.value = uid;
                    option.textContent = user.nickname || user.name;
                    p2Select.appendChild(option);
                }
            });
        });
        document.getElementById('match-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newMatch = {
                local: document.getElementById('match-local').value,
                horario: document.getElementById('match-horario').value,
                participante1_uid: p1Select.value,
                participante2_uid: p2Select.value,
                status: 'agendada',
                createdAt: new Date().toISOString()
            };
            if (!newMatch.local || !newMatch.horario || !newMatch.participante1_uid || !newMatch.participante2_uid) {
                document.getElementById('match-error').textContent = "Todos os campos são obrigatórios.";
                return;
            }
            try {
                await push(ref(db, 'matches/'), newMatch);
                alert('Partida criada com sucesso!');
                e.target.reset();
                matchModal.classList.add('hidden');
                loadInitialData(); 
            } catch (error) {
                document.getElementById('match-error').textContent = "Erro ao salvar a partida.";
            }
        });
        const searchButton = document.getElementById('search-matches-btn');
        const searchInput = document.getElementById('search-player-name');
        const searchPlayerMatches = () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('matches-search-results-container');
            const noResultsMessage = document.getElementById('no-matches-found-message');
            resultsContainer.innerHTML = '';
            noResultsMessage.classList.add('hidden');
            currentSearchedUserId = null;
            if (!searchTerm) return;
            for (const [uid, user] of Object.entries(allUsers)) {
                if ((user.name || '').toLowerCase().includes(searchTerm) || (user.nickname || '').toLowerCase().includes(searchTerm)) {
                    currentSearchedUserId = uid;
                    break; 
                }
            }
            if (!currentSearchedUserId) {
                noResultsMessage.textContent = `Nenhum jogador encontrado com o termo "${searchInput.value}".`;
                noResultsMessage.classList.remove('hidden');
                return;
            }
            renderSearchedMatches();
        };
        const renderSearchedMatches = () => {
            const resultsContainer = document.getElementById('matches-search-results-container');
            const noResultsMessage = document.getElementById('no-matches-found-message');
            resultsContainer.innerHTML = '';
            if (!currentSearchedUserId) return;
            const playerMatches = Object.entries(allMatches).filter(([_, match]) => 
                match.participante1_uid === currentSearchedUserId || match.participante2_uid === currentSearchedUserId
            ).sort((a, b) => new Date(b[1].horario) - new Date(a[1].horario));
            if (playerMatches.length === 0) {
                const playerName = allUsers[currentSearchedUserId]?.name || 'o jogador';
                noResultsMessage.textContent = `Nenhum jogo encontrado para ${playerName}.`;
                noResultsMessage.classList.remove('hidden');
                return;
            }
            noResultsMessage.classList.add('hidden');
            playerMatches.forEach(([matchId, matchData]) => {
                const matchCard = createMatchResultCard(matchId, matchData);
                resultsContainer.appendChild(matchCard);
            });
        };
        searchButton.addEventListener('click', searchPlayerMatches);
        searchInput.addEventListener('keydown', (e) => e.key === 'Enter' && searchPlayerMatches());
        function createMatchResultCard(matchId, match) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-md space-y-3 flex flex-col';
            const p1 = allUsers[match.participante1_uid];
            const p2 = allUsers[match.participante2_uid];
            const p1Name = p1?.nickname || p1?.name || '?';
            const p2Name = p2?.nickname || p2?.name || '?';
            const date = new Date(match.horario).toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            let statusHTML;
            if (match.status === 'finalizada') {
                statusHTML = `<div class="text-center font-bold text-sm py-1 px-3 rounded-full mt-2 bg-gray-200 text-gray-800">Finalizada: ${match.score}</div>`;
            } else {
                statusHTML = `<div class="text-center font-bold text-sm py-1 px-3 rounded-full mt-2 bg-blue-100 text-blue-800">Agendada</div>`;
            }
            card.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-gray-800">${p1Name} vs ${p2Name}</p>
                    <div class="text-sm text-gray-600 mt-2 space-y-1">
                        <p><strong>Data:</strong> ${date}</p>
                    </div>
                    ${statusHTML}
                </div>
                <div class="pt-3 border-t flex justify-end space-x-2">
                    <button class="edit-match-btn bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 text-sm font-semibold">Editar</button>
                    <button class="delete-match-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 text-sm font-semibold">Excluir</button>
                </div>
            `;
            card.querySelector('.edit-match-btn').addEventListener('click', () => openEditMatchModal(matchId, match));
            card.querySelector('.delete-match-btn').addEventListener('click', () => deleteMatch(matchId, match));
            return card;
        }

    </script>
</body>
</html>
