<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Slam - Meus Jogos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Adicionado o CSS do menu -->
    <link rel="stylesheet" href="menu.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fef9; }
    </style>
</head>
<body>
    <div id="main-content" class="hidden flex h-screen bg-gray-50 overflow-hidden">
        
        <!-- Contêiner para o menu reutilizável -->
        <div id="menu-container"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-white border-b md:hidden">
                <h1 class="text-xl font-bold text-emerald-800">Meus Jogos</h1>
                <!-- Botão de hambúrguer para o menu.js -->
                <button id="hamburger-button" class="text-gray-500 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
                <div class="container mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Histórico de Partidas</h2>
                    <div id="my-matches-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Cards de jogos serão inseridos aqui -->
                    </div>
                    <div id="no-matches-message" class="text-center py-12 text-gray-500 hidden">
                        <p class="text-xl">Você ainda não participou de nenhuma partida.</p>
                    </div>
                    <!-- Controles de Paginação -->
                    <div id="pagination-controls" class="flex justify-center items-center mt-8 space-x-4 hidden">
                        <button id="prev-page-btn" class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed">Anterior</button>
                        <span id="page-info" class="font-semibold text-gray-700"></span>
                        <button id="next-page-btn" class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed">Próxima</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="loading-view" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <svg class="animate-spin h-12 w-12 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
    </div>

    <script type="module">
        import { auth, db } from './firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { ref, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        // Importa a função do menu
        import { loadMenu } from './menu.js';

        let currentUser = null;
        let allUsersData = {};
        let myMatches = [];
        let currentPage = 1;
        const matchesPerPage = 9; // Múltiplo de 3 para melhor grid

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Carrega o menu, passando o ID da página ativa ('meusjogos')
                loadMenu('menu-container', 'meusjogos');
                loadPageData();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadPageData() {
            try {
                const usersRef = ref(db, 'users/');
                const matchesRef = ref(db, 'matches/');
                const [usersSnapshot, matchesSnapshot] = await Promise.all([get(usersRef), get(matchesRef)]);
                
                if (usersSnapshot.exists()) allUsersData = usersSnapshot.val();

                if (matchesSnapshot.exists()) {
                    const allMatches = Object.values(matchesSnapshot.val());
                    myMatches = allMatches.filter(match => 
                        match.participante1_uid === currentUser.uid || match.participante2_uid === currentUser.uid
                    ).sort((a, b) => new Date(b.horario) - new Date(a.horario)); // Ordena do mais recente para o mais antigo
                }

                if (myMatches.length > 0) {
                    renderPage(currentPage);
                } else {
                    document.getElementById('no-matches-message').classList.remove('hidden');
                }

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
            } finally {
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            }
        }

        function renderPage(page) {
            const container = document.getElementById('my-matches-container');
            container.innerHTML = '';
            
            const start = (page - 1) * matchesPerPage;
            const end = start + matchesPerPage;
            const paginatedMatches = myMatches.slice(start, end);

            paginatedMatches.forEach(match => {
                container.appendChild(createMatchCard(match));
            });
            
            renderPaginationControls();
        }

        function renderPaginationControls() {
            const totalPages = Math.ceil(myMatches.length / matchesPerPage);
            const paginationControls = document.getElementById('pagination-controls');
            
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }
            
            paginationControls.classList.remove('hidden');
            document.getElementById('page-info').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages;
        }

        function createMatchCard(match) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-xl shadow-md space-y-4 flex flex-col';

            const opponentUID = match.participante1_uid === currentUser.uid ? match.participante2_uid : match.participante1_uid;
            const opponentData = allUsersData[opponentUID];
            const opponentName = opponentData?.nickname || opponentData?.name || 'Adversário';
            const date = new Date(match.horario).toLocaleString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            let statusHTML = '';
            if (match.status === 'finalizada') {
                const userWon = match.winner_uid === currentUser.uid;
                const resultClass = userWon ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const resultText = userWon ? 'Vitória' : 'Derrota';
                statusHTML = `
                    <div class="mt-auto pt-4 border-t">
                        <p class="font-bold text-center text-lg">${match.score || 'N/A'}</p>
                        <div class="text-center font-bold text-sm py-1 px-3 rounded-full mt-2 ${resultClass}">
                            ${resultText}
                        </div>
                    </div>`;
            } else {
                statusHTML = `
                    <div class="mt-auto pt-4 border-t text-center">
                        <div class="inline-block bg-blue-100 text-blue-800 text-sm font-bold py-1 px-3 rounded-full">
                            Agendada
                        </div>
                    </div>`;
            }

            card.innerHTML = `
                <div class="flex-grow">
                    <p class="text-sm text-gray-500">Contra</p>
                    <p class="font-bold text-xl text-emerald-700">${opponentName}</p>
                    <div class="text-sm text-gray-600 mt-3">
                        <p><strong>Local:</strong> ${match.local}</p>
                        <p><strong>Data:</strong> ${date}</p>
                    </div>
                </div>
                ${statusHTML}
            `;
            return card;
        }

        document.getElementById('prev-page-btn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        });

        document.getElementById('next-page-btn').addEventListener('click', () => {
            const totalPages = Math.ceil(myMatches.length / matchesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderPage(currentPage);
            }
        });
    </script>
</body>
</html>
